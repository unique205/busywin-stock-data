<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIBAS - Live Stock Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; }
        .last-sync { font-size: 0.9rem; color: #6c757d; }
        .stock-positive { color: #198754; }
        .stock-zero { color: #dc3545; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1rem; transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .live-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .update-notification { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .price-badge { font-size: 0.85rem; margin: 2px; }
        #barcode-scanner-modal .modal-content { border-radius: 15px; }
        #barcode-scanner-modal .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        #interactive.viewport { position: relative; width: 100%; height: 300px; }
        #interactive.viewport canvas, #interactive.viewport video { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }
        .scanner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 3px solid #007bff; border-radius: 10px; pointer-events: none; }
        .scanner-line { position: absolute; width: 100%; height: 2px; background: #007bff; top: 50%; animation: scan 2s infinite linear; }
        @keyframes scan { 0% { top: 10%; } 50% { top: 90%; } 100% { top: 10%; } }
        .barcode-result { background: #28a745; color: white; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="text-center"><i class="fas fa-warehouse me-3"></i>LIBAS Stock Data</h1>
            <div class="text-center">
                <div id="lastSync" class="last-sync">Loading data...</div>
                <div id="connectionStatus" class="last-sync">
                    <span id="statusIndicator" class="badge bg-secondary">Connecting...</span>
                </div>
            </div>
        </div>
    </div>

    <div id="updateNotification" class="update-notification alert alert-success d-none">
        <i class="fas fa-sync me-2"></i>Data updated successfully!
    </div>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-8 mx-auto">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search items by name, alias, or group...">
                    <button class="btn btn-primary" type="button" id="barcodeScannerBtn">
                        <i class="fas fa-barcode me-2"></i>Scan Barcode
                    </button>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 id="itemCount">Items: 0</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showOutOfStock" checked>
                        <label class="form-check-label" for="showOutOfStock">Show out of stock</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div id="loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading stock data...</p>
                </div>
                <div id="itemsContainer" class="d-none">
                    <div id="itemsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div class="modal fade" id="barcodeScannerModal" tabindex="-1" aria-labelledby="barcodeScannerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="barcodeScannerModalLabel">
                        <i class="fas fa-barcode me-2"></i>Barcode Scanner
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="interactive" class="viewport">
                        <div class="scanner-overlay">
                            <div class="scanner-line"></div>
                        </div>
                    </div>
                    <div id="barcodeResult" class="barcode-result d-none"></div>
                    <div id="scannerStatus" class="mt-3">
                        <p class="text-muted">Point camera at barcode to scan</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="switchCameraBtn">
                        <i class="fas fa-camera-rotate me-2"></i>Switch Camera
                    </button>
                    <button type="button" class="btn btn-danger" id="stopScannerBtn">
                        <i class="fas fa-stop me-2"></i>Stop Scanner
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentData = [];
        let lastDataHash = '';
        let autoRefreshInterval;
        let isOnline = true;
        let quaggaInitialized = false;
        let currentFacingMode = 'environment'; // 'environment' for rear camera, 'user' for front

        // Initialize the application
        async function initializeApp() {
            await loadData();
            setupAutoRefresh();
            setupConnectionMonitoring();
            setupBarcodeScanner();
        }

        // Load data from GitHub
        async function loadData() {
            try {
                showLoading(true);
                updateStatus('ðŸ”„ Loading data...', 'warning');
                
                const timestamp = new Date().getTime();
                const response = await fetch(`https://raw.githubusercontent.com/unique205/busywin-stock-data/main/stock_data.js?t=${timestamp}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const jsCode = await response.text();
                eval(jsCode);
                
                const newDataHash = generateDataHash(window.stockData);
                const dataChanged = newDataHash !== lastDataHash;
                
                currentData = window.stockData || [];
                lastDataHash = newDataHash;
                
                updateStatus('âœ… Connected - Live updates active', 'success');
                showData(dataChanged);
                
                if (dataChanged && currentData.length > 0) {
                    showUpdateNotification();
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateStatus('âŒ Error loading data', 'danger');
                showLoading(false);
                setTimeout(loadData, 10000);
            }
        }

        // Setup barcode scanner
        function setupBarcodeScanner() {
            const scannerBtn = document.getElementById('barcodeScannerBtn');
            const scannerModal = new bootstrap.Modal(document.getElementById('barcodeScannerModal'));
            const switchCameraBtn = document.getElementById('switchCameraBtn');
            const stopScannerBtn = document.getElementById('stopScannerBtn');

            scannerBtn.addEventListener('click', () => {
                scannerModal.show();
                setTimeout(initBarcodeScanner, 500); // Wait for modal to fully show
            });

            switchCameraBtn.addEventListener('click', switchCamera);
            stopScannerBtn.addEventListener('click', () => {
                stopBarcodeScanner();
                scannerModal.hide();
            });

            // Close scanner when modal is hidden
            document.getElementById('barcodeScannerModal').addEventListener('hidden.bs.modal', stopBarcodeScanner);
        }

        // Initialize barcode scanner
        function initBarcodeScanner() {
            if (quaggaInitialized) {
                Quagga.start();
                return;
            }

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        facingMode: currentFacingMode,
                        width: { min: 640 },
                        height: { min: 480 }
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ]
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
            }, function(err) {
                if (err) {
                    console.error('Error initializing Quagga:', err);
                    document.getElementById('scannerStatus').innerHTML = 
                        '<p class="text-danger">Error accessing camera. Please check permissions.</p>';
                    return;
                }
                console.log('Quagga initialized successfully');
                quaggaInitialized = true;
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                console.log('Barcode detected:', code);
                
                // Show result
                const resultDiv = document.getElementById('barcodeResult');
                resultDiv.textContent = `Scanned: ${code}`;
                resultDiv.className = 'barcode-result';
                
                // Search for the barcode
                const found = searchByBarcode(code);
                
                if (found) {
                    resultDiv.classList.add('bg-success');
                    // Auto-close after 2 seconds
                    setTimeout(() => {
                        stopBarcodeScanner();
                        bootstrap.Modal.getInstance(document.getElementById('barcodeScannerModal')).hide();
                    }, 2000);
                } else {
                    resultDiv.classList.add('bg-danger');
                    resultDiv.textContent += ' - Not found';
                    // Keep scanner running for retry
                }
            });
        }

        // Switch between front and rear camera
        function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            stopBarcodeScanner();
            setTimeout(initBarcodeScanner, 500);
        }

        // Stop barcode scanner
        function stopBarcodeScanner() {
            if (Quagga && quaggaInitialized) {
                Quagga.stop();
            }
            document.getElementById('barcodeResult').classList.add('d-none');
        }

        // Search by barcode/alias
        function searchByBarcode(barcode) {
            const searchTerm = barcode.trim();
            if (!searchTerm) return false;
            
            const filtered = currentData.filter(item => 
                (item.ItemAlias && item.ItemAlias.includes(searchTerm)) ||
                (item.ItemCode && item.ItemCode.includes(searchTerm))
            );
            
            if (filtered.length > 0) {
                renderItems(filtered);
                document.getElementById('searchInput').value = searchTerm;
                
                // Show found message
                const originalCount = document.getElementById('itemCount').textContent;
                document.getElementById('itemCount').textContent = 
                    `Found: ${filtered.length} item(s) for barcode: ${searchTerm}`;
                
                // Reset after 5 seconds
                setTimeout(() => {
                    document.getElementById('itemCount').textContent = originalCount;
                }, 5000);
                return true;
            } else {
                // Show not found message
                document.getElementById('itemCount').textContent = 
                    `No items found for barcode: ${searchTerm}`;
                
                // Reset after 3 seconds
                setTimeout(() => {
                    document.getElementById('itemCount').textContent = `Items: ${currentData.length}`;
                }, 3000);
                return false;
            }
        }

        // Show/hide loading indicator
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('d-none', !show);
            document.getElementById('itemsContainer').classList.toggle('d-none', show);
        }

        // Update connection status
        function updateStatus(message, type) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            indicator.className = `badge bg-${type} live-indicator`;
            
            document.getElementById('lastSync').textContent = 
                `Last updated: ${window.lastUpdated || 'Unknown'}`;
        }

        // Show data with change detection
        function showData(dataChanged) {
            showLoading(false);
            
            if (dataChanged) {
                document.getElementById('itemCount').textContent = `Items: ${currentData.length}`;
                renderItems(currentData);
            }
            
            setupEventListeners();
        }

        // Render items list
        function renderItems(items) {
            const container = document.getElementById('itemsList');
            const showOutOfStock = document.getElementById('showOutOfStock').checked;
            
            let filteredItems = items;
            if (!showOutOfStock) {
                filteredItems = items.filter(item => parseFloat(item.Stock) > 0);
            }
            
            container.innerHTML = filteredItems.map(item => `
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="card-title">${escapeHtml(item.ItemName || 'N/A')}</h6>
                                <p class="card-text mb-1">
                                    <small class="text-muted">Alias: ${escapeHtml(item.ItemAlias || 'N/A')}</small>
                                </p>
                                <p class="card-text mb-1">
                                    <small class="text-muted">Group: ${escapeHtml(item.GroupName || 'N/A')}</small>
                                </p>
                                <div class="mt-2">
                                    <span class="badge bg-primary price-badge">MRP: â‚¹${parseFloat(item.Item_MRP || 0).toFixed(2)}</span>
                                    <span class="badge bg-success price-badge">Sale: â‚¹${parseFloat(item.Item_Sale_Price || 0).toFixed(2)}</span>
                                    <span class="badge bg-warning text-dark price-badge">Wholesale: â‚¹${parseFloat(item.Item_SelfVal_Price || 0).toFixed(2)}</span>
                                    <span class="badge ${parseFloat(item.Stock) > 0 ? 'bg-success' : 'bg-danger'} price-badge">
                                        Stock: ${parseFloat(item.Stock || 0)}
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <small class="text-muted">Code: ${escapeHtml(item.ItemCode || 'N/A')}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('itemCount').textContent = `Items: ${filteredItems.length} (${items.length} total)`;
        }

        // Setup auto-refresh every 30 seconds
        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(async () => {
                if (isOnline) {
                    await loadData();
                }
            }, 30000);
        }

        // Monitor internet connection
        function setupConnectionMonitoring() {
            window.addEventListener('online', () => {
                isOnline = true;
                updateStatus('âœ… Connected - Live updates active', 'success');
                loadData();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateStatus('âŒ Offline - Showing cached data', 'warning');
            });
        }

        // Show update notification
        function showUpdateNotification() {
            const notification = document.getElementById('updateNotification');
            notification.classList.remove('d-none');
            
            setTimeout(() => {
                notification.classList.add('d-none');
            }, 3000);
        }

        // Generate hash for change detection
        function generateDataHash(data) {
            return btoa(JSON.stringify(data)).substring(0, 32);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchInput').oninput = function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = currentData.filter(item => 
                    (item.ItemName && item.ItemName.toLowerCase().includes(searchTerm)) ||
                    (item.ItemAlias && item.ItemAlias.toLowerCase().includes(searchTerm)) ||
                    (item.GroupName && item.GroupName.toLowerCase().includes(searchTerm)) ||
                    (item.ItemCode && item.ItemCode.toLowerCase().includes(searchTerm))
                );
                renderItems(filtered);
            };
            
            // Stock filter
            document.getElementById('showOutOfStock').onchange = function(e) {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                let filtered = currentData;
                
                if (!e.target.checked) {
                    filtered = currentData.filter(item => parseFloat(item.Stock) > 0);
                }
                
                if (searchTerm) {
                    filtered = filtered.filter(item => 
                        (item.ItemName && item.ItemName.toLowerCase().includes(searchTerm)) ||
                        (item.ItemAlias && item.ItemAlias.toLowerCase().includes(searchTerm)) ||
                        (item.GroupName && item.GroupName.toLowerCase().includes(searchTerm)) ||
                        (item.ItemCode && item.ItemCode.toLowerCase().includes(searchTerm))
                    );
                }
                
                renderItems(filtered);
            };
        }

        // Utility function to escape HTML
        function escapeHtml(unsafe) {
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Manual refresh function
        window.manualRefresh = function() {
            loadData();
        };

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

    <div class="container mt-4 mb-4">
        <div class="text-center">
            <button class="btn btn-primary" onclick="manualRefresh()">
                <i class="fas fa-sync me-2"></i>Refresh Now
            </button>
            <small class="d-block mt-2 text-muted">Auto-refreshes every 30 seconds</small>
            <small class="d-block mt-1 text-muted">Click "Scan Barcode" to use camera scanner</small>
        </div>
    </div>
</body>
</html>