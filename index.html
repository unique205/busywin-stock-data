<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIBAS - Live Stock Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; }
        .last-sync { font-size: 0.9rem; color: #6c757d; }
        .stock-positive { color: #198754; }
        .stock-zero { color: #dc3545; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1rem; transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .live-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .update-notification { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .price-badge { font-size: 0.85rem; margin: 2px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="text-center"><i class="fas fa-warehouse me-3"></i>LIBAS Stock Data</h1>
            <div class="text-center">
                <div id="lastSync" class="last-sync">Loading data...</div>
                <div id="connectionStatus" class="last-sync">
                    <span id="statusIndicator" class="badge bg-secondary">Connecting...</span>
                </div>
            </div>
        </div>
    </div>

    <div id="updateNotification" class="update-notification alert alert-success d-none">
        <i class="fas fa-sync me-2"></i>Data updated successfully!
    </div>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-8 mx-auto">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search items by name, alias, or group...">
                    <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 id="itemCount">Items: 0</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showOutOfStock" checked>
                        <label class="form-check-label" for="showOutOfStock">Show out of stock</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div id="loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading stock data...</p>
                </div>
                <div id="itemsContainer" class="d-none">
                    <div id="itemsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let lastDataHash = '';
        let autoRefreshInterval;
        let isOnline = true;

        // Initialize the application
        async function initializeApp() {
            await loadData();
            setupAutoRefresh();
            setupConnectionMonitoring();
            setupBarcodeScanner();
        }

        // Load data from GitHub
        async function loadData() {
            try {
                showLoading(true);
                updateStatus('ðŸ”„ Loading data...', 'warning');
                
                // Add cache busting to prevent browser caching
                const timestamp = new Date().getTime();
                const response = await fetch(`https://raw.githubusercontent.com/unique205/busywin-stock-data/main/stock_data.js?t=${timestamp}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const jsCode = await response.text();
                
                // Execute the JavaScript to get the data
                eval(jsCode);
                
                // Check if data has changed
                const newDataHash = generateDataHash(window.stockData);
                const dataChanged = newDataHash !== lastDataHash;
                
                currentData = window.stockData || [];
                lastDataHash = newDataHash;
                
                updateStatus('âœ… Connected - Live updates active', 'success');
                showData(dataChanged);
                
                if (dataChanged && currentData.length > 0) {
                    showUpdateNotification();
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateStatus('âŒ Error loading data', 'danger');
                showLoading(false);
                
                // Try again in 10 seconds if error
                setTimeout(loadData, 10000);
            }
        }

        // Show/hide loading indicator
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('d-none', !show);
            document.getElementById('itemsContainer').classList.toggle('d-none', show);
        }

        // Update connection status
        function updateStatus(message, type) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            indicator.className = `badge bg-${type} live-indicator`;
            
            document.getElementById('lastSync').textContent = 
                `Last updated: ${window.lastUpdated || 'Unknown'}`;
        }

        // Show data with change detection
        function showData(dataChanged) {
            showLoading(false);
            
            if (dataChanged) {
                document.getElementById('itemCount').textContent = `Items: ${currentData.length}`;
                renderItems(currentData);
            }
            
            setupEventListeners();
        }

        // Render items list
        function renderItems(items) {
            const container = document.getElementById('itemsList');
            const showOutOfStock = document.getElementById('showOutOfStock').checked;
            
            let filteredItems = items;
            if (!showOutOfStock) {
                filteredItems = items.filter(item => parseFloat(item.Stock) > 0);
            }
            
            container.innerHTML = filteredItems.map(item => `
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="card-title">${escapeHtml(item.ItemName || 'N/A')}</h6>
                                <p class="card-text mb-1">
                                    <small class="text-muted">Alias: ${escapeHtml(item.ItemAlias || 'N/A')}</small>
                                </p>
                                <p class="card-text mb-1">
                                    <small class="text-muted">Group: ${escapeHtml(item.GroupName || 'N/A')}</small>
                                </p>
                                <div class="mt-2">
                                    <span class="badge bg-primary price-badge">MRP: â‚¹${parseFloat(item.Item_MRP || 0).toFixed(2)}</span>
                                    <span class="badge bg-success price-badge">Sale: â‚¹${parseFloat(item.Item_Sale_Price || 0).toFixed(2)}</span>
                                    <span class="badge bg-warning text-dark price-badge">Wholesale: â‚¹${parseFloat(item.Item_SelfVal_Price || 0).toFixed(2)}</span>
                                    <span class="badge ${parseFloat(item.Stock) > 0 ? 'bg-success' : 'bg-danger'} price-badge">
                                        Stock: ${parseFloat(item.Stock || 0)}
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <small class="text-muted">Code: ${escapeHtml(item.ItemCode || 'N/A')}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('itemCount').textContent = `Items: ${filteredItems.length} (${items.length} total)`;
        }

        // Setup barcode scanner functionality
        function setupBarcodeScanner() {
            let barcode = '';
            let lastKeyTime = 0;
            
            document.getElementById('searchInput').addEventListener('keydown', function(e) {
                const currentTime = new Date().getTime();
                
                // If time between keys is more than 50ms, reset barcode
                if (currentTime - lastKeyTime > 50) {
                    barcode = '';
                }
                
                // Add character to barcode (ignore Enter key)
                if (e.key !== 'Enter') {
                    barcode += e.key;
                }
                
                lastKeyTime = currentTime;
                
                // If barcode is complete (usually 12-13 digits) and Enter is pressed
                if (e.key === 'Enter' && barcode.length >= 6) {
                    searchByBarcode(barcode);
                    barcode = ''; // Reset barcode
                    e.preventDefault(); // Prevent form submission
                }
            });
        }

        // Search by barcode/alias
        function searchByBarcode(barcode) {
            const searchTerm = barcode.trim();
            if (!searchTerm) return;
            
            const filtered = currentData.filter(item => 
                (item.ItemAlias && item.ItemAlias.includes(searchTerm)) ||
                (item.ItemCode && item.ItemCode.includes(searchTerm))
            );
            
            if (filtered.length > 0) {
                renderItems(filtered);
                document.getElementById('searchInput').value = searchTerm;
                
                // Show found message
                const originalCount = document.getElementById('itemCount').textContent;
                document.getElementById('itemCount').textContent = 
                    `Found: ${filtered.length} item(s) for barcode: ${searchTerm}`;
                
                // Reset after 3 seconds
                setTimeout(() => {
                    document.getElementById('itemCount').textContent = originalCount;
                }, 3000);
            } else {
                // Show not found message
                document.getElementById('itemCount').textContent = 
                    `No items found for barcode: ${searchTerm}`;
                
                // Reset after 3 seconds
                setTimeout(() => {
                    document.getElementById('itemCount').textContent = `Items: ${currentData.length}`;
                }, 3000);
            }
        }

        // Setup auto-refresh every 30 seconds
        function setupAutoRefresh() {
            // Clear existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Check for updates every 30 seconds
            autoRefreshInterval = setInterval(async () => {
                if (isOnline) {
                    await loadData();
                }
            }, 30000); // 30 seconds
        }

        // Monitor internet connection
        function setupConnectionMonitoring() {
            window.addEventListener('online', () => {
                isOnline = true;
                updateStatus('âœ… Connected - Live updates active', 'success');
                loadData(); // Immediately load data when back online
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateStatus('âŒ Offline - Showing cached data', 'warning');
            });
        }

        // Show update notification
        function showUpdateNotification() {
            const notification = document.getElementById('updateNotification');
            notification.classList.remove('d-none');
            
            setTimeout(() => {
                notification.classList.add('d-none');
            }, 3000);
        }

        // Generate hash for change detection
        function generateDataHash(data) {
            return btoa(JSON.stringify(data)).substring(0, 32);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchInput').oninput = function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = currentData.filter(item => 
                    (item.ItemName && item.ItemName.toLowerCase().includes(searchTerm)) ||
                    (item.ItemAlias && item.ItemAlias.toLowerCase().includes(searchTerm)) ||
                    (item.GroupName && item.GroupName.toLowerCase().includes(searchTerm)) ||
                    (item.ItemCode && item.ItemCode.toLowerCase().includes(searchTerm))
                );
                renderItems(filtered);
            };
            
            // Stock filter
            document.getElementById('showOutOfStock').onchange = function(e) {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                let filtered = currentData;
                
                if (!e.target.checked) {
                    filtered = currentData.filter(item => parseFloat(item.Stock) > 0);
                }
                
                if (searchTerm) {
                    filtered = filtered.filter(item => 
                        (item.ItemName && item.ItemName.toLowerCase().includes(searchTerm)) ||
                        (item.ItemAlias && item.ItemAlias.toLowerCase().includes(searchTerm)) ||
                        (item.GroupName && item.GroupName.toLowerCase().includes(searchTerm)) ||
                        (item.ItemCode && item.ItemCode.toLowerCase().includes(searchTerm))
                    );
                }
                
                renderItems(filtered);
            };
        }

        // Utility function to escape HTML
        function escapeHtml(unsafe) {
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Manual refresh function
        window.manualRefresh = function() {
            loadData();
        };

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

    <div class="container mt-4 mb-4">
        <div class="text-center">
            <button class="btn btn-primary" onclick="manualRefresh()">
                <i class="fas fa-sync me-2"></i>Refresh Now
            </button>
            <small class="d-block mt-2 text-muted">Auto-refreshes every 30 seconds</small>
            <small class="d-block mt-1 text-muted">Type barcode and press Enter to scan</small>
        </div>
    </div>
</body>
</html>